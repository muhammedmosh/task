// Firebase SDK imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  updateDoc,
  deleteDoc,
  doc,
  arrayUnion,
  addDoc,
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

// Firebase configuration
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID",
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM Elements
const logoutBtn = document.querySelector("#logoutBtn");
const personalTasksList = document.querySelector("#personalTasksList");
const taskTableBody = document.querySelector("#taskTableBody");
const statsModal = document.querySelector("#statsModal");
const commentModal = document.querySelector("#commentModal");
const commentInput = document.querySelector("#commentInput");
const saveCommentBtn = document.querySelector("#saveCommentBtn");

// Utility function for handling errors
function handleError(error) {
  console.error("Error: ", error);
  alert("Something went wrong. Please try again.");
}

// Load personal tasks
async function loadPersonalTasks() {
  const user = auth.currentUser;
  if (!user) return;

  try {
    const personalTasksQuery = query(
      collection(db, "personalTasks"),
      where("userId", "==", user.uid)
    );
    const snapshot = await getDocs(personalTasksQuery);

    personalTasksList.innerHTML = snapshot.empty
      ? "<p class='text-gray-600'>No personal tasks available.</p>"
      : "";

    snapshot.forEach((doc) => {
      const task = doc.data();
      const taskDiv = document.createElement("div");
      taskDiv.className = "mb-4 p-4 border rounded";
      taskDiv.innerHTML = `
        <h3 class="text-xl">${task.taskName}</h3>
        <p>${task.description}</p>
        <p class="text-sm text-gray-500">${task.activityType}</p>
        <button class="text-blue-600" onclick="editPersonalTask('${doc.id}')">Edit</button>
        <button class="text-red-600 ml-4" onclick="deletePersonalTask('${doc.id}')">Delete</button>
      `;
      personalTasksList.appendChild(taskDiv);
    });
  } catch (error) {
    handleError(error);
  }
}

// Load tasks assigned to the user
async function loadTasks() {
  const user = auth.currentUser;
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    const tasksQuery = query(
      collection(db, "tasks"),
      where("assignedTo", "==", user.uid)
    );
    const snapshot = await getDocs(tasksQuery);

    taskTableBody.innerHTML = snapshot.empty
      ? "<tr><td colspan='3' class='text-center py-4'>No tasks found.</td></tr>"
      : "";

    snapshot.forEach((doc) => {
      const task = doc.data();
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="py-2 px-4 border-b">${task.taskName}</td>
        <td class="py-2 px-4 border-b">${task.status}</td>
        <td class="py-2 px-4 border-b">
          <button class="text-blue-600" onclick="updateTaskStatus('${doc.id}')">Update Status</button>
          <button class="text-yellow-600 ml-4" onclick="openCommentModal('${doc.id}')">Comment</button>
        </td>
      `;
      taskTableBody.appendChild(row);
    });
  } catch (error) {
    handleError(error);
  }
}

// Update task status
async function updateTaskStatus(taskId) {
    const taskRef = doc(db, "tasks", taskId);
    const taskDoc = await getDoc(taskRef);
    const taskData = taskDoc.data();
    const newStatus = taskData.status === "Pending" ? "In Progress" : "Completed";

    await updateDoc(taskRef, { status: newStatus });
    loadTasks(); // Refresh tasks
  }



// Open comment modal
function openCommentModal(taskId) {
  commentModal.classList.remove("hidden");
  saveCommentBtn.onclick = async () => {
    const comment = commentInput.value.trim();
    if (!comment) {
      alert("Please enter a comment.");
      return;
    }

    try {
      const taskRef = doc(db, "tasks", taskId);
      await updateDoc(taskRef, {
        comments: arrayUnion({
          text: comment,
          date: new Date().toISOString(),
        }),
      });
      alert("Comment added successfully.");
      commentModal.classList.add("hidden");
      commentInput.value = "";
    } catch (error) {
      handleError(error);
    }
  };
}

// Delete personal task
async function deletePersonalTask(taskId) {
  try {
    await deleteDoc(doc(db, "personalTasks", taskId));
    alert("Personal task deleted successfully.");
    loadPersonalTasks();
  } catch (error) {
    handleError(error);
  }
}

// Logout user
logoutBtn.addEventListener("click", async () => {
  try {
    await signOut(auth);
    window.location.href = "login.html";
  } catch (error) {
    handleError(error);
  }
});

// Monitor auth state
onAuthStateChanged(auth, (user) => {
  if (user) {
    loadPersonalTasks();
    loadTasks();
  } else {
    window.location.href = "login.html";
  }
});
